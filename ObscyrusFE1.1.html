<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscyrus GGUF Chat</title>
    <style>
        @font-face {
            font-family: 'VT323';
            src: url('/static/fonts/VT323-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            margin: 0;
            font-family: 'VT323', monospace;
            background-color: #000000;
            color: #ff9ac1;
            overflow: hidden;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: all;
        }
        .conversations-sidebar {
            position: fixed;
            top: 10vh;
            left: -300px;
            width: 300px;
            height: 80vh;
            background: rgba(30, 30, 30, 0.95);
            border-top: 4px solid;
            border-bottom: 4px solid;
            border-right: 4px solid;
            border-image: linear-gradient(to right, #ff9ac1, #660099) 1;
            box-shadow: 0 0 15px rgba(102, 0, 153, 0.6);
            padding: 10px;
            z-index: 1001; /* Higher z-index to overlap */
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        .conversations-sidebar::-webkit-scrollbar {
            display: none;
        }
        .conversations-sidebar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .conversations-sidebar.open {
            left: 0;
        }
        .codes-sidebar {
            position: fixed;
            top: 10vh;
            right: -300px;
            width: 300px;
            height: 80vh;
            background: rgba(30, 30, 30, 0.95);
            border-top: 4px solid;
            border-bottom: 4px solid;
            border-left: 4px solid;
            border-image: linear-gradient(to left, #ff9ac1, #660099) 1;
            box-shadow: 0 0 15px rgba(102, 0, 153, 0.6);
            padding: 10px;
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        .codes-sidebar::-webkit-scrollbar {
            display: none;
        }
        .codes-sidebar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .codes-sidebar.open {
            right: 0;
        }
        .conversations-sidebar h3, .codes-sidebar h3, .workspace-panel h3 {
            font-size: 32px;
            background: linear-gradient(45deg, #ff9ac1, #660099);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 8px rgba(255, 154, 193, 0.8);
            margin: 0 0 10px;
            text-align: center;
        }
        .convo-list, .code-list {
            list-style: none;
            padding: 0;
        }
        .convo-item, .code-item {
            padding: 5px;
            background: #2e2e2e;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .convo-item:hover, .code-item:hover {
            background: #4b0082;
        }
        .convo-name, .code-name {
            flex-grow: 1;
            font-size: 20px;
        }
        .convo-btn, .code-btn {
            background: none;
            border: none;
            color: #ff9ac1;
            cursor: pointer;
            font-size: 16px;
            margin-left: 5px;
        }
        .conversations-btn {
            position: fixed;
            top: 20px;
            left: 0;
            padding: 5px 10px;
            border-radius: 8px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 18px;
            z-index: 1001;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .codes-btn {
            position: fixed;
            top: 20px;
            right: 0;
            padding: 5px 10px;
            border-radius: 8px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 18px;
            z-index: 1001;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .workspace-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            border-radius: 8px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 18px;
            z-index: 1001;
        }
        .conversations-btn:hover, .codes-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255, 154, 193, 0.7);
        }
        .workspace-btn:hover {
            background: #e88ab0;
        }
        .workspace-btn:active {
            background: #d27a9f;
        }
        .convo-close-btn, .code-close-btn, .workspace-close-btn {
            padding: 5px 10px;
            border-radius: 8px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .sidebar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 80vh;
            background: rgba(30, 30, 30, 0.95);
            border: 4px solid;
            border-image: linear-gradient(to bottom, #ff9ac1, #660099) 1;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(102, 0, 153, 0.6);
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: left 0.3s ease;
        }
        .sidebar.shifted {
            left: 25%;
        }
        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .sidebar h2 {
            font-size: 64px;
            background: linear-gradient(45deg, #ff9ac1, #660099);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 8px rgba(255, 154, 193, 0.8);
            margin: 0 0 30px;
            text-align: center;
            animation: textGradient 5s ease infinite;
        }
        @keyframes textGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .model-select {
            width: 100%;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 8px;
            background: #2e2e2e;
            border: 1px solid #660099;
            color: #ff9ac1;
            font-family: 'VT323', monospace;
            font-size: 32px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .model-select:focus {
            outline: none;
            border-color: #ff9ac1;
            box-shadow: 0 0 8px rgba(255, 154, 193, 0.5);
        }
        .chat-area {
            flex-grow: 1;
            background: #2e2e2e;
            border: 1px solid #660099;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 30px;
            color: #ff9ac1;
            font-size: 36px;
        }
        .chat-message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            font-family: 'VT323', monospace;
        }
        .user-message {
            background: rgba(255, 255, 255, 0.1);
            color: #87ceeb;
            text-align: right;
        }
        .bot-message {
            background: #4b0082;
            color: #22c55e;
        }
        .info-message {
            background: rgba(255, 105, 180, 0.2);
            color: #ffb6c1;
        }
        .error-message {
            background: #3c0066;
            color: #ef4444;
        }
        .image-message {
            text-align: center;
        }
        .input-area {
            display: flex;
            gap: 15px;
        }
        .prompt-input {
            flex-grow: 1;
            padding: 15px;
            border-radius: 8px;
            background: #2e2e2e;
            border: 1px solid #660099;
            color: #ff9ac1;
            font-family: 'VT323', monospace;
            font-size: 36px;
        }
        .prompt-input:focus {
            outline: none;
            border-color: #ff9ac1;
            box-shadow: 0 0 8px rgba(255, 154, 193, 0.5);
        }
        .submit-btn {
            padding: 15px 25px;
            border-radius: 8px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 36px;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .submit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255, 154, 193, 0.7);
        }
        .morphing-container {
            position: fixed;
            width: 80px;
            height: 80px;
            z-index: 2000;
            display: none;
        }
        .morphing-container.visible {
            display: flex;
        }
        .morphing-container.centered {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .morphing-container.bottom-right {
            top: 50%;
            left: calc(50% + 300px + 50px);
            transform: translateY(-50%);
        }
        .blob {
            position: absolute;
            width: 80px;
            height: 80px;
            animation: liquidMorph 2.5s ease-in-out infinite;
            filter: blur(1.5px) contrast(1.3) saturate(1.2);
        }
        .blob-layer-1 {
            background: linear-gradient(45deg, #ff4040, #ff9ac1, #c71585, #660099, #c8a2c8);
            background-size: 600% 600%;
            animation: liquidMorph 2.5s ease-in-out infinite, rapidGradientShift3s ease-in-out infinite;
            box-shadow: 
                0 0 6px rgba(102, 0, 153, 0.5),
                0 0 10px rgba(153, 50, 204, 0.4),
                0 0 14px rgba(255, 154, 193, 0.3),
                inset 0 0 5px rgba(255, 255, 255, 0.15);
        }
        .blob-layer-2 {
            background: radial-gradient(circle, #ff9ac1, #c71585);
            animation: liquidMorph 2.5s ease-in-out infinite reverse, liquidPulse 2s ease-in-out infinite;
            animation-delay: 0.3s;
            filter: blur(1px);
        }
        .blob-layer-3 {
            background: radial-gradient(ellipse, #ff4040, #c8a2c8 60%, transparent 80%);
            animation: liquidMorph 2.5s ease-in-out infinite, liquidRotate 5s linear infinite;
            animation-delay: 0.6s;
            filter: blur(2px);
            transform-origin: center;
        }
        .code-panel {
            position: fixed;
            top: 50%;
            left: 75%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 80vh;
            background: #1e1e1e;
            border: 2px solid #660099;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(102, 0, 153, 0.6);
            padding: 20px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        .code-panel.visible {
            display: block;
        }
        #codeContent {
            width: 100%;
            height: calc(100% - 50px);
        }
        .code-panel-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .code-panel-btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            background: #ff9ac1;
            color: #000000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 24px;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .code-panel-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255, 154, 193, 0.7);
        }
        .workspace-panel {
            position: fixed;
            bottom: -80vh;
            left: 50%;
            transform: translateX(-50%);
            width: 33vw;
            height: 80vh;
            background: rgba(30, 30, 30, 0.95);
            border-top: 4px solid;
            border-image: linear-gradient(to right, #ff9ac1, #660099) 1;
            box-shadow: 0 0 15px rgba(102, 0, 153, 0.6);
            padding: 10px;
            z-index: 1001;
            transition: bottom 0.3s ease;
            overflow: hidden;
        }
        .workspace-panel.open {
            bottom: 0;
        }
        .workspace-panel #folderUpload {
            margin-bottom: 10px;
            display: block;
            margin: 0 auto;
        }
        .workspace-panel input[type="file"]::file-selector-button {
            background: #4b0082;
            color: #000;
            border-radius: 50px;
            padding: 5px 10px;
            border: none;
        }
        .file-tree {
            width: 100%;
            height: calc(100% - 120px);
            overflow-y: auto;
            background: #2e2e2e;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .file-tree ul {
            list-style: none;
            padding-left: 20px;
            margin: 0 auto;
            display: inline-block;
            text-align: left;
        }
        .file-tree li {
            cursor: pointer;
            color: #ff9ac1;
        }
        .file-tree li:hover {
            color: #ffffff;
        }
        @keyframes liquidMorph {
            0% { border-radius: 45% 55% 35% 65% / 50% 60% 40% 50%; transform: scale(1) rotate(0deg) skew(0deg, 0deg); }
            10% { border-radius: 65% 35% 75% 25% / 40% 80% 20% 60%; transform: scale(1.1) rotate(18deg) skew(2deg, -1deg); }
            20% { border-radius: 25% 75% 45% 55% / 70% 30% 60% 40%; transform: scale(0.95) rotate(36deg) skew(-3deg, 2deg); }
            30% { border-radius: 80% 20% 60% 40% / 30% 70% 50% 50%; transform: scale(1.15) rotate(54deg) skew(1deg, -3deg); }
            40% { border-radius: 40% 60% 20% 80% / 60% 40% 80% 20%; transform: scale(0.9) rotate(72deg) skew(-2deg, 1deg); }
            50% { border-radius: 60% 40% 80% 20% / 20% 80% 30% 70%; transform: scale(1.2) rotate(90deg) skew(3deg, -2deg); }
            60% { border-radius: 20% 80% 30% 70% / 80% 20% 70% 30%; transform: scale(1.05) rotate(108deg) skew(-1deg, 3deg); }
            70% { border-radius: 75% 25% 65% 35% / 45% 55% 25% 75%; transform: scale(0.85) rotate(126deg) skew(2deg, -1deg); }
            80% { border-radius: 35% 65% 55% 45% / 75% 25% 65% 35%; transform: scale(1.25) rotate(144deg) skew(-3deg, 2deg); }
            90% { border-radius: 55% 45% 25% 75% / 55% 45% 75% 25%; transform: scale(1.1) rotate(162deg) skew(1deg, -2deg); }
            100% { border-radius: 45% 55% 35% 65% / 50% 60% 40% 50%; transform: scale(1) rotate(180deg) skew(0deg, 0deg); }
        }
        @keyframes rapidGradientShift {
            0% { background-position: 0% 50%; }
            20% { background-position: 100% 80%; }
            40% { background-position: 0% 100%; }
            60% { background-position: 80% 20%; }
            80% { background-position: 20% 0%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes liquidPulse {
            0%, 100% { transform: scale(1) scaleX(1.1); opacity: 0.8; }
            33% { transform: scale(1.15) scaleX(0.9); opacity: 1; }
            66% { transform: scale(0.95) scaleX(1.2); opacity: 0.9; }
        }
        @keyframes liquidRotate {
            0% { transform: rotate(0deg) scaleY(1.1); }
            25% { transform: rotate(90deg) scaleY(0.9); }
            50% { transform: rotate(180deg) scaleY(1.2); }
            75% { transform: rotate(270deg) scaleY(0.8); }
            100% { transform: rotate(360deg) scaleY(1.1); }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <button class="conversations-btn" id="conversationsBtn">Conversations</button>
    <div class="conversations-sidebar" id="conversationsSidebar">
        <button class="convo-close-btn" id="convoCloseBtn">Close</button>
        <h3>Conversations</h3>
        <button class="submit-btn" id="newConvoBtn">New Conversation</button>
        <ul class="convo-list" id="convoList"></ul>
    </div>
    <button class="codes-btn" id="codesBtn">Codes</button>
    <div class="codes-sidebar" id="codesSidebar">
        <button class="code-close-btn" id="codeCloseBtn">Close</button>
        <h3>Codes</h3>
        <ul class="code-list" id="codeList"></ul>
    </div>
    <div class="sidebar" id="sidebar">
        <h2>Obscyrus Chat</h2>
        <select class="model-select" id="modelSelect">
            <option value="">Select a GGUF Model</option>
        </select>
        <div class="chat-area" id="chatArea"></div>
        <div class="input-area">
            <input type="text" class="prompt-input" id="promptInput" placeholder="Type your message or /generate for code...">
            <button class="submit-btn" id="submitBtn">Send</button>
            <button class="submit-btn" id="saveConvoBtn">Save Convo</button>
        </div>
    </div>
    <div class="code-panel" id="codePanel">
        <div class="code-panel-buttons">
            <button class="code-panel-btn" id="closeBtn">Close</button>
            <button class="code-panel-btn" id="saveBtn">Save</button>
        </div>
        <div id="codeContent"></div>
    </div>
    <button class="workspace-btn" id="workspaceBtn">Workspace</button>
    <div class="workspace-panel" id="workspacePanel">
        <button class="workspace-close-btn" id="workspaceCloseBtn">Close</button>
        <h3>Workspace</h3>
        <input type="file" webkitdirectory id="folderUpload">
        <div class="file-tree" id="fileTree"></div>
    </div>
    <div class="morphing-container" id="blobContainer">
        <div class="blob blob-layer-3"></div>
        <div class="blob blob-layer-2"></div>
        <div class="blob blob-layer-1"></div>
    </div>

    <script src="/static/particlesjs/particles.min.js"></script>
    <script src="/static/SocketIO/socket.io.min.js"></script>
    <script src="/static/monaco-editor/min/vs/loader.js"></script>
    <script>
        // Initialize particles.js
        particlesJS('particles-js', {
            particles: {
                number: { value: 333, density: { enable: true, value_area: 800 } },
                color: { value: ['#ff9ac1', '#660099', '#ff4040'] },
                shape: { type: 'circle', stroke: { width: 0, color: '#000000' } },
                opacity: { value: 0.6, random: true },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 120,
                    color: '#ff9ac1',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'grab' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                },
                modes: {
                    grab: { distance: 200, line_linked: { opacity: 0.7 } },
                    push: { particles_nb: 4 }
                }
            },
            retina_detect: true
        });

        const socket = io();
        const sidebar = document.getElementById('sidebar');
        const codePanel = document.getElementById('codePanel');
        const codeContent = document.getElementById('codeContent');
        const blobContainer = document.getElementById('blobContainer');
        const conversationsSidebar = document.getElementById('conversationsSidebar');
        const conversationsBtn = document.getElementById('conversationsBtn');
        const convoList = document.getElementById('convoList');
        const newConvoBtn = document.getElementById('newConvoBtn');
        const convoCloseBtn = document.getElementById('convoCloseBtn');
        const codesSidebar = document.getElementById('codesSidebar');
        const codesBtn = document.getElementById('codesBtn');
        const codeList = document.getElementById('codeList');
        const codeCloseBtn = document.getElementById('codeCloseBtn');
        const saveConvoBtn = document.getElementById('saveConvoBtn');
        const promptInput = document.getElementById('promptInput');
        const workspaceBtn = document.getElementById('workspaceBtn');
        const workspacePanel = document.getElementById('workspacePanel');
        const workspaceCloseBtn = document.getElementById('workspaceCloseBtn');
        const folderUpload = document.getElementById('folderUpload');
        const fileTree = document.getElementById('fileTree');

        let codeEditor = null;

        // Initialize the code editor once on page load
        require.config({ paths: { 'vs': '/static/monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            codeEditor = monaco.editor.create(codeContent, {
                value: '',
                language: 'plaintext',
                theme: 'vs-dark',
                readOnly: true,
                minimap: { enabled: false },
                scrollbar: { vertical: 'auto' },
                automaticLayout: true
            });

            // Preload languages to improve highlighting speed
            ['html', 'css', 'javascript', 'python'].forEach(lang => {
                const tempModel = monaco.editor.createModel('', lang);
                tempModel.dispose();
            });
        });

        // Load available models
        fetch('/api/models')
            .then(response => response.json())
            .then(data => {
                const modelSelect = document.getElementById('modelSelect');
                if (data.models) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                } else {
                    appendMessage('error-message', 'Error: No models found');
                }
            })
            .catch(error => {
                appendMessage('error-message', `Error loading models: ${error}`);
            });

        // Handle model selection
        document.getElementById('modelSelect').addEventListener('change', (event) => {
            const model = event.target.value;
            if (model) {
                socket.emit('select_model', { model });
            }
        });

        // Toggle conversations sidebar
        conversationsBtn.addEventListener('click', () => {
            conversationsSidebar.classList.add('open');
            socket.emit('convo_list');
        });

        // Close conversations sidebar
        convoCloseBtn.addEventListener('click', () => {
            conversationsSidebar.classList.remove('open');
        });

        // New conversation
        newConvoBtn.addEventListener('click', () => {
            socket.emit('convo_create');
            document.getElementById('chatArea').innerHTML = '';
        });

        // Save conversation
        saveConvoBtn.addEventListener('click', () => {
            const name = prompt('Enter conversation name (leave blank for auto-generated):');
            socket.emit('convo_save', { name: name || '' });
        });

        // Toggle codes sidebar
        codesBtn.addEventListener('click', () => {
            codesSidebar.classList.add('open');
            loadCodes();
        });

        // Close codes sidebar
        codeCloseBtn.addEventListener('click', () => {
            codesSidebar.classList.remove('open');
        });

        // Toggle workspace panel
        workspaceBtn.addEventListener('click', () => {
            workspacePanel.classList.add('open');
            loadWorkspaceTree();  // Load tree when opening
        });

        // Close workspace panel
        workspaceCloseBtn.addEventListener('click', () => {
            workspacePanel.classList.remove('open');
        });

        // Handle folder upload
        folderUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            const formData = new FormData();
            for (let file of files) {
                formData.append('files[]', file, file.webkitRelativePath);
            }
            fetch('/api/upload_workspace', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                appendMessage('info-message', data.message || data.error);
                loadWorkspaceTree();
            })
            .catch(error => {
                appendMessage('error-message', `Error uploading workspace: ${error}`);
            });
        });

        // Load workspace tree
        function loadWorkspaceTree() {
            fetch('/api/workspace_files')
                .then(response => response.json())
                .then(data => {
                    fileTree.innerHTML = '';
                    const rootUl = document.createElement('ul');
                    const pathMap = {};
                    data.files.forEach(rel => {
                        const pathParts = rel.split('/');
                        let current = pathMap;
                        pathParts.forEach((part, index) => {
                            if (!current[part]) {
                                current[part] = {};
                            }
                            if (index === pathParts.length - 1) {
                                current[part].filename = rel;
                            }
                            current = current[part];
                        });
                    });

                    function buildTree(map, ul) {
                        Object.keys(map).sort().forEach(key => {
                            const li = document.createElement('li');
                            const isFolder = !map[key].filename;
                            li.textContent = key + (isFolder ? '/' : '');
                            ul.appendChild(li);
                            if (isFolder) {
                                const subUl = document.createElement('ul');
                                li.appendChild(subUl);
                                buildTree(map[key], subUl);
                            } else {
                                li.addEventListener('click', () => {
                                    fetch('/api/get_workspace_code', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ filename: map[key].filename })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (codeEditor) {
                                            codeEditor.setValue(data.code);
                                            monaco.editor.setModelLanguage(codeEditor.getModel(), getMonacoLanguage(data.lang || 'plaintext'));
                                            sidebar.classList.add('shifted');
                                            codePanel.classList.add('visible');
                                            codeEditor.layout();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error loading workspace code:', error);
                                    });
                                });
                            }
                        });
                    }

                    buildTree(pathMap, rootUl);
                    fileTree.appendChild(rootUl);
                })
                .catch(error => {
                    console.error('Error loading workspace files:', error);
                });
        }

        // Load codes list
        function loadCodes() {
            fetch('/api/codes')
                .then(response => response.json())
                .then(data => {
                    codeList.innerHTML = '';
                    data.codes.forEach(code => {
                        const li = document.createElement('li');
                        li.className = 'code-item';
                        li.innerHTML = `
                            <span class="code-name">${code}</span>
                            <button class="code-btn open" data-filename="${code}">Open</button>
                            <button class="code-btn rename" data-filename="${code}">Rename</button>
                            <button class="code-btn delete" data-filename="${code}">Delete</button>
                        `;
                        codeList.appendChild(li);
                    });
                    // Add event listeners
                    document.querySelectorAll('.open').forEach(btn => {
                        btn.addEventListener('click', () => {
                            fetch('/api/get_code', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ filename: btn.dataset.filename })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (!codesSidebar.classList.contains('open')) return;
                                    if (codeEditor) {
                                        codeEditor.setValue(data.code);
                                        monaco.editor.setModelLanguage(codeEditor.getModel(), getMonacoLanguage(data.lang || 'plaintext'));
                                        sidebar.classList.add('shifted');
                                        codePanel.classList.add('visible');
                                        codeEditor.layout();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading code:', error);
                                });
                        });
                    });
                    document.querySelectorAll('.rename').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const newFilename = prompt('New filename (include extension):', btn.dataset.filename);
                            if (newFilename) {
                                fetch('/api/rename_code', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ old_filename: btn.dataset.filename, new_filename: newFilename })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        loadCodes();
                                    })
                                    .catch(error => {
                                        console.error('Error renaming code:', error);
                                    });
                            }
                        });
                    });
                    document.querySelectorAll('.delete').forEach(btn => {
                        btn.addEventListener('click', () => {
                            if (confirm('Delete code?')) {
                                fetch('/api/delete_code', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ filename: btn.dataset.filename })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        loadCodes();
                                    })
                                    .catch(error => {
                                        console.error('Error deleting code:', error);
                                    });
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading codes:', error);
                });
        }

        function getMonacoLanguage(lang) {
            const langMap = {
                'py': 'python',
                'python': 'python',
                'js': 'javascript',
                'javascript': 'javascript',
                'ts': 'typescript',
                'typescript': 'typescript',
                'html': 'html',
                'htm': 'html',
                'css': 'css',
                'json': 'json',
                'sql': 'sql',
                'cs': 'csharp',
                'csharp': 'csharp',
                'cpp': 'cpp',
                'c': 'c',
                // add more if needed
            };
            return langMap[lang.toLowerCase()] || 'plaintext';
        }

        function getExtensionFromLanguage(lang) {
            const extMap = {
                'python': 'py',
                'javascript': 'js',
                'typescript': 'ts',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'sql': 'sql',
                'csharp': 'cs',
                'cpp': 'cpp',
                'c': 'c',
                // add more if needed
            };
            return extMap[lang] || 'txt';
        }

        // Load convo list
        socket.on('convo_list', (data) => {
            convoList.innerHTML = '';
            data.convos.forEach(convo => {
                const li = document.createElement('li');
                li.className = 'convo-item';
                li.innerHTML = `
                    <span class="convo-name">${convo.name}</span>
                    <button class="convo-btn load" data-id="${convo.id}">Load</button>
                    <button class="convo-btn rename" data-id="${convo.id}">Rename</button>
                    <button class="convo-btn delete" data-id="${convo.id}">Delete</button>
                `;
                convoList.appendChild(li);
            });
            // Add event listeners for load, rename, delete
            document.querySelectorAll('.load').forEach(btn => {
                btn.addEventListener('click', () => {
                    socket.emit('convo_load', { id: btn.dataset.id });
                    document.getElementById('chatArea').innerHTML = '';
                });
            });
            document.querySelectorAll('.rename').forEach(btn => {
                btn.addEventListener('click', () => {
                    const name = prompt('New name:');
                    if (name) {
                        socket.emit('convo_rename', { id: btn.dataset.id, name });
                    }
                });
            });
            document.querySelectorAll('.delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Delete conversation?')) {
                        socket.emit('convo_delete', { id: btn.dataset.id });
                    }
                });
            });
        });

        // Handle convo loaded
        socket.on('convo_loaded', (data) => {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            data.messages.forEach(msg => {
                appendMessage(msg.role === 'user' ? 'user-message' : 'bot-message', msg.content);
            });
        });

        // Handle prompt submission
        document.getElementById('submitBtn').addEventListener('click', () => {
            const promptInput = document.getElementById('promptInput');
            const prompt = promptInput.value.trim();
            if (prompt) {
                appendMessage('user-message', prompt);
                let current_code = '';
                if (prompt.toLowerCase().startsWith('/edit') && codeEditor) {
                    current_code = codeEditor.getValue();
                }
                socket.emit('chat', { prompt, current_code });
                promptInput.value = '';
                const isCodePrompt = prompt.toLowerCase().startsWith('/generate') || prompt.toLowerCase().startsWith('/edit');
                if (isCodePrompt) {
                    sidebar.classList.add('shifted');
                    codePanel.classList.add('visible');
                    if (prompt.toLowerCase().startsWith('/generate') && codeEditor) {
                        codeEditor.setValue('');
                    }
                    if (codeEditor) {
                        codeEditor.layout();
                    }
                } else {
                    sidebar.classList.remove('shifted');
                    codePanel.classList.remove('visible');
                }
                setBlobPosition();
                showBlobAnimation();
                appendMessage('bot-message', '');
            }
        });

        // Allow Enter key to submit prompt
        document.getElementById('promptInput').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                document.getElementById('submitBtn').click();
            }
        });

        // Handle close button
        document.getElementById('closeBtn').addEventListener('click', () => {
            sidebar.classList.remove('shifted');
            codePanel.classList.remove('visible');
            if (codeEditor) {
                codeEditor.setValue('');
            }
        });

        // Handle save button (for code panel)
        document.getElementById('saveBtn').addEventListener('click', () => {
            const code = codeEditor ? codeEditor.getValue() : '';
            const langId = codeEditor ? codeEditor.getModel().getLanguageId() : 'plaintext';
            const defaultFilename = `generated_code.${getExtensionFromLanguage(langId)}`;
            const filename = prompt('Filename (include extension):', defaultFilename);
            if (filename) {
                fetch('/api/save_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, filename })
                })
                    .then(response => response.json())
                    .then(data => {
                        appendMessage('info-message', data.message || data.error);
                        if (codesSidebar.classList.contains('open')) loadCodes();  // Refresh if open
                    })
                    .catch(error => {
                        appendMessage('error-message', `Error saving code: ${error}`);
                    });
            }
        });

        // WebSocket event handlers
        socket.on('text_token', (data) => {
            const lastMessage = document.querySelector('.bot-message:last-child');
            if (lastMessage) {
                lastMessage.textContent += data.token;
                const chatArea = document.getElementById('chatArea');
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        });

        socket.on('code', (data) => {
            if (codeEditor) {
                codeEditor.setValue(data.code);
                monaco.editor.setModelLanguage(codeEditor.getModel(), getMonacoLanguage(data.lang || 'plaintext'));
                codeEditor.layout();
            }
        });

        socket.on('end_response', () => {
            hideBlobAnimation();
        });

        socket.on('success', (data) => {
            hideBlobAnimation();
            appendMessage('info-message', data.message);
            promptInput.placeholder = 'Type your message or /generate for code...';
        });

        socket.on('error', (data) => {
            hideBlobAnimation();
            appendMessage('error-message', data.message);
        });

        socket.on('convo_saved', (data) => {
            appendMessage('info-message', `Conversation saved as ${data.name}`);
            socket.emit('convo_list');
        });

        socket.on('convo_renamed', (data) => {
            appendMessage('info-message', `Conversation renamed to ${data.name}`);
            socket.emit('convo_list');
        });

        socket.on('convo_deleted', (data) => {
            appendMessage('info-message', 'Conversation deleted');
            socket.emit('convo_list');
        });

        // Append message to chat area
        function appendMessage(type, message) {
            const chatArea = document.getElementById('chatArea');
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${type}`;
            messageElement.textContent = message;
            chatArea.appendChild(messageElement);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Set blob position based on code panel visibility
        function setBlobPosition() {
            if (codePanel.classList.contains('visible')) {
                blobContainer.classList.remove('bottom-right');
                blobContainer.classList.add('centered');
            } else {
                blobContainer.classList.remove('centered');
                blobContainer.classList.add('bottom-right');
            }
        }

        // Show blob animation during response generation
        function showBlobAnimation() {
            blobContainer.classList.add('visible');
        }

        // Hide blob animation after response
        function hideBlobAnimation() {
            blobContainer.classList.remove('visible');
        }

        // Initial convo create
        socket.emit('convo_create');
        socket.emit('convo_list');
    </script>
</body>
</html>